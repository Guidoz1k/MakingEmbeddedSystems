#include "custom.h"

#define	ADC_SP	GPIOA,GPIO_PIN_6	// PA06 = ADC1_INP16 for the soft-pot
#define	LED		GPIOA,GPIO_PIN_1	// PA01 = board built-in LED

#define	I2S_WS	GPIOA,GPIO_PIN_4	// PA04 = I2S1_WS	(LCK)
#define	I2S_CK	GPIOA,GPIO_PIN_5	// PA05 = I2S1_CK	(BCK)
#define	I2S_SDO	GPIOA,GPIO_PIN_7	// PA06 = I2S1_SDO	(DIN)

#define	LCD_D0	GPIOD,GPIO_PIN_0	// PD00 = LCD data pin 0
#define	LCD_D1	GPIOD,GPIO_PIN_1	// PD01 = LCD data pin 1
#define	LCD_D2	GPIOD,GPIO_PIN_2	// PD02 = LCD data pin 2
#define	LCD_D3	GPIOD,GPIO_PIN_3	// PD03 = LCD data pin 3
#define	LCD_D4	GPIOD,GPIO_PIN_4	// PD04 = LCD data pin 4
#define	LCD_D5	GPIOD,GPIO_PIN_5	// PD05 = LCD data pin 5
#define	LCD_D6	GPIOD,GPIO_PIN_6	// PD06 = LCD data pin 6
#define	LCD_D7	GPIOD,GPIO_PIN_7	// PD07 = LCD data pin 7

#define	LCD_RS	GPIOE,GPIO_PIN_0	// PE00 = LCD RS pin
#define	LCD_EN	GPIOE,GPIO_PIN_1	// PE01 = LCD E pin

#define	BUT_UP	GPIOE,GPIO_PIN_2	// PE02 = UP button
#define	BUT_DWN	GPIOE,GPIO_PIN_3	// PE03 = DOWN button
#define	BUT_RGT	GPIOE,GPIO_PIN_4	// PE04 = RIGHT button
#define	BUT_LFT	GPIOE,GPIO_PIN_5	// PE05 = LEFT button

#define BUT_K2	GPIOC,GPIO_PIN_5	// PC05 = K2 onboard button

#define LUT_SIZE	2000

static ADC_HandleTypeDef hadc1;
static I2S_HandleTypeDef hi2s1;

// 88 keys of a piano
static uint32_t tone[] = {
							  27,   29,   31,   33,   35,   37,   39,   41,   44,   46,   49,   52,
							  55,   58,   62,   65,   69,   73,   78,   82,   87,   92,   98,  104,
							 110,  117,  123,  131,  139,  147,  156,  165,  175,  185,  196,  208,
							 220,  233,  247,  262,  277,  294,  311,  330,  349,  370,  392,  415,
							 440,  466,  494,  523,  554,  587,  622,  659,  698,  740,  784,  830,
							 880,  932,  988, 1046, 1109, 1175, 1244, 1318, 1397, 1480, 1568, 1661,
							1760, 1865, 1975, 2093, 2218, 2349, 2489, 2637, 2794, 2960, 3136, 3322,
							3520, 3729, 3951, 4186
};

// LUT
static uint16_t LUT[] = {
		32767, 32869, 32972, 33075, 33178, 33281, 33384, 33487, 33590, 33693, 33796, 33899, 34001, 34104, 34207, 34310, 34413, 34516, 34618, 34721,
		34824, 34927, 35029, 35132, 35235, 35337, 35440, 35543, 35645, 35748, 35850, 35953, 36055, 36157, 36260, 36362, 36464, 36567, 36669, 36771,
		36873, 36975, 37077, 37179, 37281, 37383, 37485, 37587, 37689, 37791, 37892, 37994, 38096, 38197, 38299, 38400, 38501, 38603, 38704, 38805,
		38906, 39008, 39109, 39210, 39310, 39411, 39512, 39613, 39713, 39814, 39914, 40015, 40115, 40215, 40316, 40416, 40516, 40616, 40716, 40816,
		40915, 41015, 41115, 41214, 41313, 41413, 41512, 41611, 41710, 41809, 41908, 42007, 42106, 42204, 42303, 42401, 42500, 42598, 42696, 42794,
		42892, 42990, 43088, 43185, 43283, 43380, 43478, 43575, 43672, 43769, 43866, 43963, 44059, 44156, 44252, 44349, 44445, 44541, 44637, 44733,
		44829, 44924, 45020, 45115, 45211, 45306, 45401, 45496, 45591, 45685, 45780, 45874, 45969, 46063, 46157, 46251, 46344, 46438, 46531, 46625,
		46718, 46811, 46904, 46997, 47089, 47182, 47274, 47367, 47459, 47551, 47642, 47734, 47826, 47917, 48008, 48099, 48190, 48281, 48371, 48462,
		48552, 48642, 48732, 48822, 48912, 49001, 49091, 49180, 49269, 49358, 49446, 49535, 49623, 49711, 49799, 49887, 49975, 50062, 50150, 50237,
		50324, 50411, 50497, 50584, 50670, 50756, 50842, 50928, 51014, 51099, 51184, 51269, 51354, 51439, 51523, 51608, 51692, 51776, 51860, 51943,
		52026, 52110, 52193, 52275, 52358, 52440, 52523, 52605, 52687, 52768, 52850, 52931, 53012, 53093, 53173, 53254, 53334, 53414, 53494, 53574,
		53653, 53732, 53811, 53890, 53969, 54047, 54125, 54203, 54281, 54358, 54436, 54513, 54590, 54666, 54743, 54819, 54895, 54971, 55047, 55122,
		55197, 55272, 55347, 55421, 55495, 55569, 55643, 55717, 55790, 55863, 55936, 56009, 56081, 56154, 56226, 56297, 56369, 56440, 56511, 56582,
		56653, 56723, 56793, 56863, 56933, 57002, 57071, 57140, 57209, 57277, 57345, 57413, 57481, 57549, 57616, 57683, 57749, 57816, 57882, 57948,
		58014, 58079, 58145, 58210, 58274, 58339, 58403, 58467, 58531, 58594, 58658, 58720, 58783, 58846, 58908, 58970, 59031, 59093, 59154, 59215,
		59276, 59336, 59396, 59456, 59515, 59575, 59634, 59693, 59751, 59809, 59867, 59925, 59983, 60040, 60097, 60153, 60210, 60266, 60322, 60377,
		60433, 60488, 60542, 60597, 60651, 60705, 60759, 60812, 60865, 60918, 60970, 61023, 61075, 61126, 61178, 61229, 61280, 61330, 61381, 61431,
		61480, 61530, 61579, 61628, 61677, 61725, 61773, 61821, 61868, 61915, 61962, 62009, 62055, 62101, 62147, 62192, 62237, 62282, 62327, 62371,
		62415, 62459, 62502, 62545, 62588, 62630, 62673, 62715, 62756, 62798, 62839, 62879, 62920, 62960, 63000, 63039, 63079, 63117, 63156, 63194,
		63232, 63270, 63308, 63345, 63382, 63418, 63454, 63490, 63526, 63561, 63596, 63631, 63665, 63700, 63733, 63767, 63800, 63833, 63866, 63898,
		63930, 63961, 63993, 64024, 64055, 64085, 64115, 64145, 64174, 64204, 64232, 64261, 64289, 64317, 64345, 64372, 64399, 64426, 64452, 64478,
		64504, 64530, 64555, 64579, 64604, 64628, 64652, 64676, 64699, 64722, 64744, 64767, 64789, 64810, 64832, 64853, 64873, 64894, 64914, 64934,
		64953, 64972, 64991, 65010, 65028, 65046, 65063, 65080, 65097, 65114, 65130, 65146, 65162, 65177, 65192, 65207, 65221, 65235, 65249, 65262,
		65275, 65288, 65300, 65312, 65324, 65336, 65347, 65358, 65368, 65378, 65388, 65398, 65407, 65416, 65424, 65432, 65440, 65448, 65455, 65462,
		65469, 65475, 65481, 65487, 65492, 65497, 65502, 65506, 65510, 65514, 65517, 65520, 65523, 65526, 65528, 65529, 65531, 65532, 65533, 65533,
		65534, 65533, 65533, 65532, 65531, 65529, 65528, 65526, 65523, 65520, 65517, 65514, 65510, 65506, 65502, 65497, 65492, 65487, 65481, 65475,
		65469, 65462, 65455, 65448, 65440, 65432, 65424, 65416, 65407, 65398, 65388, 65378, 65368, 65358, 65347, 65336, 65324, 65312, 65300, 65288,
		65275, 65262, 65249, 65235, 65221, 65207, 65192, 65177, 65162, 65146, 65130, 65114, 65097, 65080, 65063, 65046, 65028, 65010, 64991, 64972,
		64953, 64934, 64914, 64894, 64873, 64853, 64832, 64810, 64789, 64767, 64744, 64722, 64699, 64676, 64652, 64628, 64604, 64579, 64555, 64530,
		64504, 64478, 64452, 64426, 64399, 64372, 64345, 64317, 64289, 64261, 64232, 64204, 64174, 64145, 64115, 64085, 64055, 64024, 63993, 63961,
		63930, 63898, 63866, 63833, 63800, 63767, 63733, 63700, 63665, 63631, 63596, 63561, 63526, 63490, 63454, 63418, 63382, 63345, 63308, 63270,
		63232, 63194, 63156, 63117, 63079, 63039, 63000, 62960, 62920, 62879, 62839, 62798, 62756, 62715, 62673, 62630, 62588, 62545, 62502, 62459,
		62415, 62371, 62327, 62282, 62237, 62192, 62147, 62101, 62055, 62009, 61962, 61915, 61868, 61821, 61773, 61725, 61677, 61628, 61579, 61530,
		61480, 61431, 61381, 61330, 61280, 61229, 61178, 61126, 61075, 61023, 60970, 60918, 60865, 60812, 60759, 60705, 60651, 60597, 60542, 60488,
		60433, 60377, 60322, 60266, 60210, 60153, 60097, 60040, 59983, 59925, 59867, 59809, 59751, 59693, 59634, 59575, 59515, 59456, 59396, 59336,
		59276, 59215, 59154, 59093, 59031, 58970, 58908, 58846, 58783, 58720, 58658, 58594, 58531, 58467, 58403, 58339, 58274, 58210, 58145, 58079,
		58014, 57948, 57882, 57816, 57749, 57683, 57616, 57549, 57481, 57413, 57345, 57277, 57209, 57140, 57071, 57002, 56933, 56863, 56793, 56723,
		56653, 56582, 56511, 56440, 56369, 56297, 56226, 56154, 56081, 56009, 55936, 55863, 55790, 55717, 55643, 55569, 55495, 55421, 55347, 55272,
		55197, 55122, 55047, 54971, 54895, 54819, 54743, 54666, 54590, 54513, 54436, 54358, 54281, 54203, 54125, 54047, 53969, 53890, 53811, 53732,
		53653, 53574, 53494, 53414, 53334, 53254, 53173, 53093, 53012, 52931, 52850, 52768, 52687, 52605, 52523, 52440, 52358, 52275, 52193, 52110,
		52026, 51943, 51860, 51776, 51692, 51608, 51523, 51439, 51354, 51269, 51184, 51099, 51014, 50928, 50842, 50756, 50670, 50584, 50497, 50411,
		50324, 50237, 50150, 50062, 49975, 49887, 49799, 49711, 49623, 49535, 49446, 49358, 49269, 49180, 49091, 49001, 48912, 48822, 48732, 48642,
		48552, 48462, 48371, 48281, 48190, 48099, 48008, 47917, 47826, 47734, 47642, 47551, 47459, 47367, 47274, 47182, 47089, 46997, 46904, 46811,
		46718, 46625, 46531, 46438, 46344, 46251, 46157, 46063, 45969, 45874, 45780, 45685, 45591, 45496, 45401, 45306, 45211, 45115, 45020, 44924,
		44829, 44733, 44637, 44541, 44445, 44349, 44252, 44156, 44059, 43963, 43866, 43769, 43672, 43575, 43478, 43380, 43283, 43185, 43088, 42990,
		42892, 42794, 42696, 42598, 42500, 42401, 42303, 42204, 42106, 42007, 41908, 41809, 41710, 41611, 41512, 41413, 41313, 41214, 41115, 41015,
		40915, 40816, 40716, 40616, 40516, 40416, 40316, 40215, 40115, 40015, 39914, 39814, 39713, 39613, 39512, 39411, 39310, 39210, 39109, 39008,
		38906, 38805, 38704, 38603, 38501, 38400, 38299, 38197, 38096, 37994, 37892, 37791, 37689, 37587, 37485, 37383, 37281, 37179, 37077, 36975,
		36873, 36771, 36669, 36567, 36464, 36362, 36260, 36157, 36055, 35953, 35850, 35748, 35645, 35543, 35440, 35337, 35235, 35132, 35029, 34927,
		34824, 34721, 34618, 34516, 34413, 34310, 34207, 34104, 34001, 33899, 33796, 33693, 33590, 33487, 33384, 33281, 33178, 33075, 32972, 32869,
		32767, 32664, 32561, 32458, 32355, 32252, 32149, 32046, 31943, 31840, 31737, 31634, 31532, 31429, 31326, 31223, 31120, 31017, 30915, 30812,
		30709, 30606, 30504, 30401, 30298, 30196, 30093, 29990, 29888, 29785, 29683, 29580, 29478, 29376, 29273, 29171, 29069, 28966, 28864, 28762,
		28660, 28558, 28456, 28354, 28252, 28150, 28048, 27946, 27844, 27742, 27641, 27539, 27437, 27336, 27234, 27133, 27032, 26930, 26829, 26728,
		26627, 26525, 26424, 26324, 26223, 26122, 26021, 25920, 25820, 25719, 25619, 25518, 25418, 25318, 25217, 25117, 25017, 24917, 24817, 24717,
		24618, 24518, 24418, 24319, 24220, 24120, 24021, 23922, 23823, 23724, 23625, 23526, 23427, 23329, 23230, 23132, 23033, 22935, 22837, 22739,
		22641, 22543, 22445, 22348, 22250, 22153, 22055, 21958, 21861, 21764, 21667, 21570, 21474, 21377, 21281, 21184, 21088, 20992, 20896, 20800,
		20704, 20609, 20513, 20418, 20322, 20227, 20132, 20037, 19942, 19848, 19753, 19659, 19564, 19470, 19376, 19282, 19189, 19095, 19002, 18908,
		18815, 18722, 18629, 18536, 18444, 18351, 18259, 18166, 18074, 17982, 17891, 17799, 17707, 17616, 17525, 17434, 17343, 17252, 17162, 17071,
		16981, 16891, 16801, 16711, 16621, 16532, 16442, 16353, 16264, 16175, 16087, 15998, 15910, 15822, 15734, 15646, 15558, 15471, 15383, 15296,
		15209, 15122, 15036, 14949, 14863, 14777, 14691, 14605, 14519, 14434, 14349, 14264, 14179, 14094, 14010, 13925, 13841, 13757, 13673, 13590,
		13507, 13423, 13340, 13258, 13175, 13093, 13010, 12928, 12846, 12765, 12683, 12602, 12521, 12440, 12360, 12279, 12199, 12119, 12039, 11959,
		11880, 11801, 11722, 11643, 11564, 11486, 11408, 11330, 11252, 11175, 11097, 11020, 10943, 10867, 10790, 10714, 10638, 10562, 10486, 10411,
		10336, 10261, 10186, 10112, 10038,  9964,  9890,  9816,  9743,  9670,  9597,  9524,  9452,  9379,  9307,  9236,  9164,  9093,  9022,  8951,
		 8880,  8810,  8740,  8670,  8600,  8531,  8462,  8393,  8324,  8256,  8188,  8120,  8052,  7984,  7917,  7850,  7784,  7717,  7651,  7585,
		 7519,  7454,  7388,  7323,  7259,  7194,  7130,  7066,  7002,  6939,  6875,  6813,  6750,  6687,  6625,  6563,  6502,  6440,  6379,  6318,
		 6257,  6197,  6137,  6077,  6018,  5958,  5899,  5840,  5782,  5724,  5666,  5608,  5550,  5493,  5436,  5380,  5323,  5267,  5211,  5156,
		 5100,  5045,  4991,  4936,  4882,  4828,  4774,  4721,  4668,  4615,  4563,  4510,  4458,  4407,  4355,  4304,  4253,  4203,  4152,  4102,
		 4053,  4003,  3954,  3905,  3856,  3808,  3760,  3712,  3665,  3618,  3571,  3524,  3478,  3432,  3386,  3341,  3296,  3251,  3206,  3162,
		 3118,  3074,  3031,  2988,  2945,  2903,  2860,  2818,  2777,  2735,  2694,  2654,  2613,  2573,  2533,  2494,  2454,  2416,  2377,  2339,
		 2301,  2263,  2225,  2188,  2151,  2115,  2079,  2043,  2007,  1972,  1937,  1902,  1868,  1833,  1800,  1766,  1733,  1700,  1667,  1635,
		 1603,  1572,  1540,  1509,  1478,  1448,  1418,  1388,  1359,  1329,  1301,  1272,  1244,  1216,  1188,  1161,  1134,  1107,  1081,  1055,
		 1029,  1003,   978,   954,   929,   905,   881,   857,   834,   811,   789,   766,   744,   723,   701,   680,   660,   639,   619,   599,
		  580,   561,   542,   523,   505,   487,   470,   453,   436,   419,   403,   387,   371,   356,   341,   326,   312,   298,   284,   271,
		  258,   245,   233,   221,   209,   197,   186,   175,   165,   155,   145,   135,   126,   117,   109,   101,    93,    85,    78,    71,
		   64,    58,    52,    46,    41,    36,    31,    27,    23,    19,    16,    13,    10,     7,     5,     4,     2,     1,     0,     0,
		    0,     0,     0,     1,     2,     4,     5,     7,    10,    13,    16,    19,    23,    27,    31,    36,    41,    46,    52,    58,
		   64,    71,    78,    85,    93,   101,   109,   117,   126,   135,   145,   155,   165,   175,   186,   197,   209,   221,   233,   245,
		  258,   271,   284,   298,   312,   326,   341,   356,   371,   387,   403,   419,   436,   453,   470,   487,   505,   523,   542,   561,
		  580,   599,   619,   639,   660,   680,   701,   723,   744,   766,   789,   811,   834,   857,   881,   905,   929,   954,   978,  1003,
		 1029,  1055,  1081,  1107,  1134,  1161,  1188,  1216,  1244,  1272,  1301,  1329,  1359,  1388,  1418,  1448,  1478,  1509,  1540,  1572,
		 1603,  1635,  1667,  1700,  1733,  1766,  1800,  1833,  1868,  1902,  1937,  1972,  2007,  2043,  2079,  2115,  2151,  2188,  2225,  2263,
		 2301,  2339,  2377,  2416,  2454,  2494,  2533,  2573,  2613,  2654,  2694,  2735,  2777,  2818,  2860,  2903,  2945,  2988,  3031,  3074,
		 3118,  3162,  3206,  3251,  3296,  3341,  3386,  3432,  3478,  3524,  3571,  3618,  3665,  3712,  3760,  3808,  3856,  3905,  3954,  4003,
		 4053,  4102,  4152,  4203,  4253,  4304,  4355,  4407,  4458,  4510,  4563,  4615,  4668,  4721,  4774,  4828,  4882,  4936,  4991,  5045,
		 5100,  5156,  5211,  5267,  5323,  5380,  5436,  5493,  5550,  5608,  5666,  5724,  5782,  5840,  5899,  5958,  6018,  6077,  6137,  6197,
		 6257,  6318,  6379,  6440,  6502,  6563,  6625,  6687,  6750,  6813,  6875,  6939,  7002,  7066,  7130,  7194,  7259,  7323,  7388,  7454,
		 7519,  7585,  7651,  7717,  7784,  7850,  7917,  7984,  8052,  8120,  8188,  8256,  8324,  8393,  8462,  8531,  8600,  8670,  8740,  8810,
		 8880,  8951,  9022,  9093,  9164,  9236,  9307,  9379,  9452,  9524,  9597,  9670,  9743,  9816,  9890,  9964, 10038, 10112, 10186, 10261,
		10336, 10411, 10486, 10562, 10638, 10714, 10790, 10867, 10943, 11020, 11097, 11175, 11252, 11330, 11408, 11486, 11564, 11643, 11722, 11801,
		11880, 11959, 12039, 12119, 12199, 12279, 12360, 12440, 12521, 12602, 12683, 12765, 12846, 12928, 13010, 13093, 13175, 13258, 13340, 13423,
		13507, 13590, 13673, 13757, 13841, 13925, 14010, 14094, 14179, 14264, 14349, 14434, 14519, 14605, 14691, 14777, 14863, 14949, 15036, 15122,
		15209, 15296, 15383, 15471, 15558, 15646, 15734, 15822, 15910, 15998, 16087, 16175, 16264, 16353, 16442, 16532, 16621, 16711, 16801, 16891,
		16981, 17071, 17162, 17252, 17343, 17434, 17525, 17616, 17707, 17799, 17891, 17982, 18074, 18166, 18259, 18351, 18444, 18536, 18629, 18722,
		18815, 18908, 19002, 19095, 19189, 19282, 19376, 19470, 19564, 19659, 19753, 19848, 19942, 20037, 20132, 20227, 20322, 20418, 20513, 20609,
		20704, 20800, 20896, 20992, 21088, 21184, 21281, 21377, 21474, 21570, 21667, 21764, 21861, 21958, 22055, 22153, 22250, 22348, 22445, 22543,
		22641, 22739, 22837, 22935, 23033, 23132, 23230, 23329, 23427, 23526, 23625, 23724, 23823, 23922, 24021, 24120, 24220, 24319, 24418, 24518,
		24618, 24717, 24817, 24917, 25017, 25117, 25217, 25318, 25418, 25518, 25619, 25719, 25820, 25920, 26021, 26122, 26223, 26324, 26424, 26525,
		26627, 26728, 26829, 26930, 27032, 27133, 27234, 27336, 27437, 27539, 27641, 27742, 27844, 27946, 28048, 28150, 28252, 28354, 28456, 28558,
		28660, 28762, 28864, 28966, 29069, 29171, 29273, 29376, 29478, 29580, 29683, 29785, 29888, 29990, 30093, 30196, 30298, 30401, 30504, 30606,
		30709, 30812, 30915, 31017, 31120, 31223, 31326, 31429, 31532, 31634, 31737, 31840, 31943, 32046, 32149, 32252, 32355, 32458, 32561, 32664
};

//////////////////////////////////////////////////////////////////////// LCD "ll" functions

static void lcd_e(uint8_t status){
    if(status)
        HAL_GPIO_WritePin(LCD_EN, GPIO_PIN_SET);
    else
        HAL_GPIO_WritePin(LCD_EN, GPIO_PIN_RESET);
}

static void lcd_rs(uint8_t status){
    if(status)
    	HAL_GPIO_WritePin(LCD_RS, GPIO_PIN_SET);
    else
    	HAL_GPIO_WritePin(LCD_RS, GPIO_PIN_RESET);
}

static void lcd_data(uint8_t data){
    if(data & (1 << 0))
    	HAL_GPIO_WritePin(LCD_D0, GPIO_PIN_SET);
    else
    	HAL_GPIO_WritePin(LCD_D0, GPIO_PIN_RESET);

    if(data & (1 << 1))
    	HAL_GPIO_WritePin(LCD_D1, GPIO_PIN_SET);
    else
    	HAL_GPIO_WritePin(LCD_D1, GPIO_PIN_RESET);

    if(data & (1 << 2))
    	HAL_GPIO_WritePin(LCD_D2, GPIO_PIN_SET);
    else
    	HAL_GPIO_WritePin(LCD_D2, GPIO_PIN_RESET);

    if(data & (1 << 3))
    	HAL_GPIO_WritePin(LCD_D3, GPIO_PIN_SET);
    else
    	HAL_GPIO_WritePin(LCD_D3, GPIO_PIN_RESET);

    if(data & (1 << 4))
    	HAL_GPIO_WritePin(LCD_D4, GPIO_PIN_SET);
    else
    	HAL_GPIO_WritePin(LCD_D4, GPIO_PIN_RESET);

    if(data & (1 << 5))
    	HAL_GPIO_WritePin(LCD_D5, GPIO_PIN_SET);
    else
    	HAL_GPIO_WritePin(LCD_D5, GPIO_PIN_RESET);

    if(data & (1 << 6))
    	HAL_GPIO_WritePin(LCD_D6, GPIO_PIN_SET);
    else
    	HAL_GPIO_WritePin(LCD_D6, GPIO_PIN_RESET);

    if(data & (1 << 7))
    	HAL_GPIO_WritePin(LCD_D7, GPIO_PIN_SET);
    else
    	HAL_GPIO_WritePin(LCD_D7, GPIO_PIN_RESET);
}

static void lcd_clear(void){
	HAL_GPIO_WritePin(LCD_RS, GPIO_PIN_RESET);
	HAL_GPIO_WritePin(LCD_EN, GPIO_PIN_RESET);
    lcd_data(0);
}

static void lcd_enable(void){
    lcd_e(0);
    HAL_Delay(1);
    lcd_e(1);
    HAL_Delay(1);
    lcd_e(0);
    HAL_Delay(1);
}

static void lcd_config(uint8_t data){
    lcd_rs(0);
    lcd_data(data);
    lcd_enable();
    lcd_clear();
}

static void lcd_write(uint8_t data){
    lcd_rs(1);
    lcd_data(data);
    lcd_enable();
    lcd_clear();
}

static void lcd_pos(uint8_t line, uint8_t pos){
    if(line)            // display second line
        pos |= 0x40;    // pos 0 of second line is mem pos 0x40
    pos |= 0x80;        // config bit set
    lcd_config(pos);
}

static void lcd_flush(void){
    lcd_rs(0);
    lcd_data(1);    // data = 0x01
    lcd_enable();
    HAL_Delay(2);
    lcd_clear();
}

static void lcd_init(void){
    lcd_config(0x06);   // display automatic cursor increment
    lcd_config(0x0C);   // active display with hidden cursor
    lcd_config(0x38);   // bit and pixel format
    lcd_flush();
    lcd_pos(0, 0);
}

//////////////////////////////////////////////////////////////////////// LCD "hal" functions

static void lcd_number(uint32_t number, uint32_t size, uint32_t line, uint32_t pos){
	uint32_t character = 0;
	uint32_t ten = 0;
	uint32_t i, j;

/*
instead of doing
		size--;
	and having a signed i, with a for like
		for(i = size; i >= 0; i--)
	with a negative threshold and a int32_t i i'll do a
		number *= 10
	and a for like
		for(i = size; i > 0; i--)
	with a uint32_t i
*/

	number *= 10;
	lcd_pos(line, pos);
	for(i = size; i > 0; i--){
		ten = 1;

		for(j = 1; j <= i; j++)
			ten *= 10;

		if(i < size)
			character = ((number / ten) % 10) + 48;
		else
			character = (number / ten) + 48;

		lcd_write(character);
	}
}

static void lcd_string(const char *pointer, uint32_t line, uint32_t pos){
	uint32_t counter = 0;

	lcd_pos(line, pos);
	while((counter++ < 16) && (*pointer != '\0'))
		lcd_write(*(pointer++));
}

//////////////////////////////////////////////////////////////////////// hal abstraction

static void delay(uint32_t time){
	HAL_Delay(time);
}

static uint32_t adc(){
	uint32_t average = 50;
	uint32_t counter = 0;
	int32_t value = 0;

	for(counter = 0; counter < average; counter++){
		HAL_ADC_Start(&hadc1);
		HAL_ADC_PollForConversion(&hadc1, 1);
		value += HAL_ADC_GetValue(&hadc1);
		HAL_ADC_Stop(&hadc1);
	}

	value /= (average * 2420);	// value ranges from 27 to 2
	value -= 2;					// value ranges from 25 to 0

	return value;
}

static void i2s(uint16_t right, uint16_t left){
	uint16_t buffer[2] = {right, left};
	HAL_StatusTypeDef bob;

	bob = HAL_I2S_Transmit(&hi2s1, buffer, 1, 1);

	if(bob != 0)
		HAL_GPIO_WritePin(LED, GPIO_PIN_SET);
	else
		HAL_GPIO_WritePin(LED, GPIO_PIN_RESET);
}

//////////////////////////////////////////////////////////////////////// main functions

void customButtonInterrupt(void){
	static uint32_t state = 0;

	HAL_GPIO_WritePin(LED, state);
	state ^= 1;

}

void customTimerInterrupt(void){
	static uint32_t counter = 0;

	i2s(LUT[counter], LUT[counter]);

	counter++;
	if(counter == LUT_SIZE)
		counter = 0;
}

void customSetup(ADC_HandleTypeDef handler1, I2S_HandleTypeDef handler2){
	//uint8_t aux = 0;

	hadc1 = handler1;
	hi2s1 = handler2;
	lcd_init();

	lcd_number(666, 3, 0, 1);
	lcd_string("ai", 1, 2);
}

void customLoop(void){
	//uint32_t buttons = 0;

}





